#ifndef ALG_H
#define ALG_H

#include <QObject>
#include <QVector>
#include <QDebug>

//#define TSKWIN_DEBUGWMSREQ

#define ISR_WINDOWSAMPLES 34
#define ISR_MAXWINDOWLEDS 32

#define TSKWIN_MAXINDEXVALUES 80u

#define TSKIN_SPATIALDISCRILINES 28
#define TSKIN_SPATIALDISCRICOLUMNS 309
#define SPATIAL_DATA_SIZE (TSKIN_SPATIALDISCRILINES * TSKIN_SPATIALDISCRICOLUMNS)

#define RX_WINDOW_ROWS 13
#define RX_WINDOW_COLS 11
#define TX_WINDOW_ROWS 4 // NOTE: according to prototype, change from 5 to 4
#define TX_WINDOW_COLS 9
#define RX_WINDOW_PP_PERCENT 70
#define TX_WINDOW_PP_PERCENT 100

#define TSKWIN_SECTOR_NUM 113

typedef struct
{
    quint16 indexNum_w;
    quint16 indexValues_wa[TSKWIN_MAXINDEXVALUES];
}WindowSpatialValues_t;


typedef struct
{
    quint16 sector_wa[RX_WINDOW_ROWS][RX_WINDOW_COLS];
}tskWin_sector_t;

class Alg
{
public:
    Alg();

    int dilation(quint16 *bufferIn_, quint16 *bufferOut_, int size_);
    int spatialDiscri(quint16 *bufferIn_, quint16 *bufferOut_, int size_);
    void lzrAttenuation(quint16 bufferIn_[], int size_);

    quint16 HPrx_Idx;
    quint16 PPrx_Idx;
    quint16 HPtx_Idx;
    quint16 PPtx_Idx;
    quint16 HPrx_MaxVal;
    quint16 PPrx_MaxVal;
    quint16 HPtx_MaxVal;
    quint16 PPtx_MaxVal;
private:
    float theta_f;
    float angleIndexBegin_f;
    quint16 angleIndexBegin_w;

    int counter;

    const WindowSpatialValues_t windowSpatialDebugValues_s[ISR_WINDOWSAMPLES/2u] = {
        {69u, {947,1256,1257,1258,1565,1566,1567,1874,1875,1876,2184,2185,2186,2493,2494,2495,2496,2803,2804,2805,3112,3113,3114,3422,3423,3424,3731,3732,3733,4040,4041,4042,4043,4350,4351,4352,4659,4660,4661,4969,4970,5588,5589,5896,5897,5898,5899,6205,6206,6207,6208,6209,6515,6516,6517,6518,6824,6825,6826,6827,7133,7134,7135,7136,7137,7443,7444,7445,7446,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535}},
        {58u, {946,947,1255,1256,1257,1564,1565,1566,1874,1875,1876,2183,2184,2185,2494,2495,3423,3731,3732,4039,4040,4041,4042,4349,4350,4351,4352,4658,4659,4660,4967,4968,4969,5586,5587,5588,5589,5895,5896,5897,5898,6205,6206,6207,6208,6515,6516,6517,6823,6824,6825,6826,7132,7133,7134,7135,7442,7443,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535}},
        {68u, {946,1255,1256,1564,1565,1873,1874,1875,2182,2183,2184,2492,2493,2494,2801,2802,2803,3110,3111,3112,3420,3421,3422,3729,3730,3731,4038,4039,4040,4348,4349,4350,4657,4658,4659,4966,4967,4968,5585,5586,5587,5588,5894,5895,5896,5897,6203,6204,6205,6206,6512,6513,6514,6515,6821,6822,6823,6824,6825,7130,7131,7132,7133,7134,7440,7441,7442,7443,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535}},
        {74u, {945,946,1254,1255,1256,1563,1564,1565,1872,1873,1874,2182,2183,2184,2491,2492,2493,2800,2801,2802,3109,3110,3111,3112,3419,3420,3421,3728,3729,3730,4037,4038,4039,4040,4346,4347,4348,4349,4656,4657,4658,4965,4966,4967,5274,5583,5584,5585,5586,5892,5893,5894,5895,5896,6202,6203,6204,6205,6511,6512,6513,6514,6820,6821,6822,6823,7129,7130,7131,7132,7438,7439,7440,7441,65535,65535,65535,65535,65535,65535}},
        {67u, {1563,1564,1872,1873,1874,2181,2182,2183,2490,2491,2492,2799,2800,2801,3108,3109,3110,3111,3418,3419,3420,3727,3728,3729,4036,4037,4038,4345,4346,4347,4348,4655,4656,4657,4964,4965,4966,5274,5582,5583,5584,5585,5891,5892,5893,5894,6200,6201,6202,6203,6509,6510,6511,6512,6818,6819,6820,6821,6822,7127,7128,7129,7130,7131,7437,7438,7439,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535}},
        {76u, {635,944,945,1253,1254,1562,1563,1564,1871,1872,1873,2180,2181,2182,2489,2490,2491,2492,2798,2799,2800,2801,3107,3108,3109,3110,3417,3418,3419,3726,3727,3728,4035,4036,4037,4344,4345,4346,4653,4654,4655,4656,4962,4963,4964,4965,5580,5581,5582,5583,5889,5890,5891,5892,5893,6198,6199,6200,6201,6202,6508,6509,6510,6511,6817,6818,6819,6820,7126,7127,7128,7129,7435,7436,7437,7438,65535,65535,65535,65535}},
        {80u, {635,943,944,1252,1253,1254,1561,1562,1563,1870,1871,1872,2179,2180,2181,2488,2489,2490,2491,2797,2798,2799,2800,3106,3107,3108,3109,3416,3417,3418,3724,3725,3726,3727,3728,4033,4034,4035,4036,4343,4344,4345,4652,4653,4654,4962,4963,4964,5579,5580,5581,5582,5888,5889,5890,5891,6197,6198,6199,6200,6506,6507,6508,6509,6510,6815,6816,6817,6818,6819,7124,7125,7126,7127,7128,7433,7434,7435,7436,7437}},
        {79u, {942,943,944,1251,1252,1253,1560,1561,1562,1869,1870,1871,2178,2179,2180,2487,2488,2489,2796,2797,2798,3105,3106,3107,3108,3415,3416,3417,3724,3725,3726,4032,4033,4034,4035,4342,4343,4344,4651,4652,4653,4960,4961,4962,5577,5578,5579,5580,5581,5886,5887,5888,5889,5890,6195,6196,6197,6198,6199,6504,6505,6506,6507,6508,6813,6814,6815,6816,6817,7122,7123,7124,7125,7126,7431,7432,7433,7434,7435,65535}},
        {76u, {633,942,943,1251,1252,1560,1561,1562,1869,1870,1871,2177,2178,2179,2180,2486,2487,2488,2489,2795,2796,2797,2798,3105,3106,3107,3414,3415,3416,3722,3723,3724,3725,4031,4032,4033,4034,4340,4341,4342,4343,4649,4650,4651,4652,4959,4960,4961,5576,5577,5578,5579,5885,5886,5887,5888,6194,6195,6196,6197,6503,6504,6505,6506,6812,6813,6814,6815,7121,7122,7123,7124,7430,7431,7432,7433,65535,65535,65535,65535}},
        {78u, {632,633,941,942,943,1250,1251,1252,1559,1560,1561,1868,1869,1870,2177,2178,2179,2486,2487,2488,2794,2795,2796,2797,3103,3104,3105,3106,3412,3413,3414,3721,3722,3723,3724,4030,4031,4032,4339,4340,4341,4648,4649,4650,4957,4958,5575,5576,5577,5883,5884,5885,5886,5887,6192,6193,6194,6195,6501,6502,6503,6504,6505,6810,6811,6812,6813,6814,7119,7120,7121,7122,7123,7428,7429,7430,7431,7432,65535,65535}},
        {75u, {632,941,942,1249,1250,1251,1252,1558,1559,1560,1867,1868,1869,2176,2177,2178,2485,2486,2487,2793,2794,2795,2796,3102,3103,3104,3105,3411,3412,3413,3414,3720,3721,3722,3723,4029,4030,4031,4338,4339,4340,4647,4648,4649,4956,4957,4958,5573,5574,5575,5576,5882,5883,5884,5885,6191,6192,6193,6194,6500,6501,6502,6503,6809,6810,6811,6812,7118,7119,7120,7121,7427,7428,7429,7430,65535,65535,65535,65535,65535}},
        {75u, {940,941,1249,1250,1558,1559,1560,1866,1867,1868,2175,2176,2177,2484,2485,2486,2793,2794,2795,3101,3102,3103,3104,3410,3411,3412,3413,3719,3720,3721,3722,4028,4029,4030,4337,4338,4339,4646,4647,4648,4954,4955,4956,4957,5572,5573,5574,5575,5881,5882,5883,5884,6189,6190,6191,6192,6193,6498,6499,6500,6501,6502,6807,6808,6809,6810,6811,7116,7117,7118,7119,7425,7426,7427,7428,65535,65535,65535,65535,65535}},
        {71u, {1557,1558,1865,1866,1867,1868,2174,2175,2176,2483,2484,2485,2791,2792,2793,2794,3100,3101,3102,3103,3410,3411,3412,3718,3719,3720,4026,4027,4028,4029,4335,4336,4337,4338,4644,4645,4646,4953,4954,4955,5263,5570,5571,5572,5573,5879,5880,5881,5882,6187,6188,6189,6190,6191,6496,6497,6498,6499,6500,6805,6806,6807,6808,6809,7115,7116,7117,7118,7424,7425,7426,65535,65535,65535,65535,65535,65535,65535,65535,65535}},
        {79u, {938,939,940,1248,1249,1556,1557,1558,1865,1866,1867,2173,2174,2175,2176,2482,2483,2484,2791,2792,2793,3099,3100,3101,3102,3408,3409,3410,3717,3718,3719,4025,4026,4027,4028,4334,4335,4336,4337,4642,4643,4644,4645,4646,4952,4953,4954,5261,5262,5569,5570,5571,5572,5877,5878,5879,5880,5881,6186,6187,6188,6189,6190,6495,6496,6497,6498,6804,6805,6806,6807,7113,7114,7115,7116,7422,7423,7424,7425,65535}},
        {76u, {938,939,940,1247,1248,1556,1557,1864,1865,1866,2172,2173,2174,2175,2481,2482,2483,2484,2790,2791,2792,3098,3099,3100,3101,3407,3408,3409,3410,3715,3716,3717,3718,4025,4026,4027,4333,4334,4335,4336,4642,4643,4644,4951,4952,4953,5261,5568,5569,5570,5876,5877,5878,5879,6184,6185,6186,6187,6188,6494,6495,6496,6497,6802,6803,6804,6805,6806,7111,7112,7113,7114,7115,7421,7422,7423,65535,65535,65535,65535}},
        {59u, {939,1246,1247,1248,1555,1556,1557,1863,1864,1865,2172,2173,2174,2481,2482,2483,3406,3407,3715,3716,4023,4024,4025,4332,4333,4334,4640,4641,4642,4643,4950,4951,4952,5566,5567,5568,5569,5875,5876,5877,5878,6184,6185,6186,6492,6493,6494,6801,6802,6803,6804,7110,7111,7112,7113,7419,7420,7421,7422,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535}},
        {67u, {1246,1247,1555,1556,1862,1863,1864,1865,2171,2172,2173,2480,2481,2482,2788,2789,2790,3097,3098,3099,3405,3406,3407,3714,3715,3716,4022,4023,4024,4025,4331,4332,4333,4640,4641,4642,4950,5565,5566,5567,5568,5873,5874,5875,5876,5877,6182,6183,6184,6185,6491,6492,6493,6494,6799,6800,6801,6802,6803,7108,7109,7110,7111,7112,7418,7419,7420,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535}},
      };
    const WindowSpatialValues_t windowSpatialValues_s[ISR_WINDOWSAMPLES/2u] = {
        {67u, {1246,1247,1555,1556,1862,1863,1864,1865,2171,2172,2173,2480,2481,2482,2788,2789,2790,3097,3098,3099,3405,3406,3407,3714,3715,3716,4022,4023,4024,4025,4331,4332,4333,4640,4641,4642,4950,5565,5566,5567,5568,5873,5874,5875,5876,5877,6182,6183,6184,6185,6491,6492,6493,6494,6799,6800,6801,6802,6803,7108,7109,7110,7111,7112,7418,7419,7420,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535}},
        {59u, {939,1246,1247,1248,1555,1556,1557,1863,1864,1865,2172,2173,2174,2481,2482,2483,3406,3407,3715,3716,4023,4024,4025,4332,4333,4334,4640,4641,4642,4643,4950,4951,4952,5566,5567,5568,5569,5875,5876,5877,5878,6184,6185,6186,6492,6493,6494,6801,6802,6803,6804,7110,7111,7112,7113,7419,7420,7421,7422,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535}},
        {76u, {938,939,940,1247,1248,1556,1557,1864,1865,1866,2172,2173,2174,2175,2481,2482,2483,2484,2790,2791,2792,3098,3099,3100,3101,3407,3408,3409,3410,3715,3716,3717,3718,4025,4026,4027,4333,4334,4335,4336,4642,4643,4644,4951,4952,4953,5261,5568,5569,5570,5876,5877,5878,5879,6184,6185,6186,6187,6188,6494,6495,6496,6497,6802,6803,6804,6805,6806,7111,7112,7113,7114,7115,7421,7422,7423,65535,65535,65535,65535}},
        {79u, {938,939,940,1248,1249,1556,1557,1558,1865,1866,1867,2173,2174,2175,2176,2482,2483,2484,2791,2792,2793,3099,3100,3101,3102,3408,3409,3410,3717,3718,3719,4025,4026,4027,4028,4334,4335,4336,4337,4642,4643,4644,4645,4646,4952,4953,4954,5261,5262,5569,5570,5571,5572,5877,5878,5879,5880,5881,6186,6187,6188,6189,6190,6495,6496,6497,6498,6804,6805,6806,6807,7113,7114,7115,7116,7422,7423,7424,7425,65535}},
        {71u, {1557,1558,1865,1866,1867,1868,2174,2175,2176,2483,2484,2485,2791,2792,2793,2794,3100,3101,3102,3103,3410,3411,3412,3718,3719,3720,4026,4027,4028,4029,4335,4336,4337,4338,4644,4645,4646,4953,4954,4955,5263,5570,5571,5572,5573,5879,5880,5881,5882,6187,6188,6189,6190,6191,6496,6497,6498,6499,6500,6805,6806,6807,6808,6809,7115,7116,7117,7118,7424,7425,7426,65535,65535,65535,65535,65535,65535,65535,65535,65535}},
        {75u, {940,941,1249,1250,1558,1559,1560,1866,1867,1868,2175,2176,2177,2484,2485,2486,2793,2794,2795,3101,3102,3103,3104,3410,3411,3412,3413,3719,3720,3721,3722,4028,4029,4030,4337,4338,4339,4646,4647,4648,4954,4955,4956,4957,5572,5573,5574,5575,5881,5882,5883,5884,6189,6190,6191,6192,6193,6498,6499,6500,6501,6502,6807,6808,6809,6810,6811,7116,7117,7118,7119,7425,7426,7427,7428,65535,65535,65535,65535,65535}},
        {75u, {632,941,942,1249,1250,1251,1252,1558,1559,1560,1867,1868,1869,2176,2177,2178,2485,2486,2487,2793,2794,2795,2796,3102,3103,3104,3105,3411,3412,3413,3414,3720,3721,3722,3723,4029,4030,4031,4338,4339,4340,4647,4648,4649,4956,4957,4958,5573,5574,5575,5576,5882,5883,5884,5885,6191,6192,6193,6194,6500,6501,6502,6503,6809,6810,6811,6812,7118,7119,7120,7121,7427,7428,7429,7430,65535,65535,65535,65535,65535}},
        {78u, {632,633,941,942,943,1250,1251,1252,1559,1560,1561,1868,1869,1870,2177,2178,2179,2486,2487,2488,2794,2795,2796,2797,3103,3104,3105,3106,3412,3413,3414,3721,3722,3723,3724,4030,4031,4032,4339,4340,4341,4648,4649,4650,4957,4958,5575,5576,5577,5883,5884,5885,5886,5887,6192,6193,6194,6195,6501,6502,6503,6504,6505,6810,6811,6812,6813,6814,7119,7120,7121,7122,7123,7428,7429,7430,7431,7432,65535,65535}},
        {76u, {633,942,943,1251,1252,1560,1561,1562,1869,1870,1871,2177,2178,2179,2180,2486,2487,2488,2489,2795,2796,2797,2798,3105,3106,3107,3414,3415,3416,3722,3723,3724,3725,4031,4032,4033,4034,4340,4341,4342,4343,4649,4650,4651,4652,4959,4960,4961,5576,5577,5578,5579,5885,5886,5887,5888,6194,6195,6196,6197,6503,6504,6505,6506,6812,6813,6814,6815,7121,7122,7123,7124,7430,7431,7432,7433,65535,65535,65535,65535}},
        {79u, {942,943,944,1251,1252,1253,1560,1561,1562,1869,1870,1871,2178,2179,2180,2487,2488,2489,2796,2797,2798,3105,3106,3107,3108,3415,3416,3417,3724,3725,3726,4032,4033,4034,4035,4342,4343,4344,4651,4652,4653,4960,4961,4962,5577,5578,5579,5580,5581,5886,5887,5888,5889,5890,6195,6196,6197,6198,6199,6504,6505,6506,6507,6508,6813,6814,6815,6816,6817,7122,7123,7124,7125,7126,7431,7432,7433,7434,7435,65535}},
        {80u, {635,943,944,1252,1253,1254,1561,1562,1563,1870,1871,1872,2179,2180,2181,2488,2489,2490,2491,2797,2798,2799,2800,3106,3107,3108,3109,3416,3417,3418,3724,3725,3726,3727,3728,4033,4034,4035,4036,4343,4344,4345,4652,4653,4654,4962,4963,4964,5579,5580,5581,5582,5888,5889,5890,5891,6197,6198,6199,6200,6506,6507,6508,6509,6510,6815,6816,6817,6818,6819,7124,7125,7126,7127,7128,7433,7434,7435,7436,7437}},
        {76u, {635,944,945,1253,1254,1562,1563,1564,1871,1872,1873,2180,2181,2182,2489,2490,2491,2492,2798,2799,2800,2801,3107,3108,3109,3110,3417,3418,3419,3726,3727,3728,4035,4036,4037,4344,4345,4346,4653,4654,4655,4656,4962,4963,4964,4965,5580,5581,5582,5583,5889,5890,5891,5892,5893,6198,6199,6200,6201,6202,6508,6509,6510,6511,6817,6818,6819,6820,7126,7127,7128,7129,7435,7436,7437,7438,65535,65535,65535,65535}},
        {67u, {1563,1564,1872,1873,1874,2181,2182,2183,2490,2491,2492,2799,2800,2801,3108,3109,3110,3111,3418,3419,3420,3727,3728,3729,4036,4037,4038,4345,4346,4347,4348,4655,4656,4657,4964,4965,4966,5274,5582,5583,5584,5585,5891,5892,5893,5894,6200,6201,6202,6203,6509,6510,6511,6512,6818,6819,6820,6821,6822,7127,7128,7129,7130,7131,7437,7438,7439,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535}},
        {74u, {945,946,1254,1255,1256,1563,1564,1565,1872,1873,1874,2182,2183,2184,2491,2492,2493,2800,2801,2802,3109,3110,3111,3112,3419,3420,3421,3728,3729,3730,4037,4038,4039,4040,4346,4347,4348,4349,4656,4657,4658,4965,4966,4967,5274,5583,5584,5585,5586,5892,5893,5894,5895,5896,6202,6203,6204,6205,6511,6512,6513,6514,6820,6821,6822,6823,7129,7130,7131,7132,7438,7439,7440,7441,65535,65535,65535,65535,65535,65535}},
        {68u, {946,1255,1256,1564,1565,1873,1874,1875,2182,2183,2184,2492,2493,2494,2801,2802,2803,3110,3111,3112,3420,3421,3422,3729,3730,3731,4038,4039,4040,4348,4349,4350,4657,4658,4659,4966,4967,4968,5585,5586,5587,5588,5894,5895,5896,5897,6203,6204,6205,6206,6512,6513,6514,6515,6821,6822,6823,6824,6825,7130,7131,7132,7133,7134,7440,7441,7442,7443,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535}},
        {58u, {946,947,1255,1256,1257,1564,1565,1566,1874,1875,1876,2183,2184,2185,2494,2495,3423,3731,3732,4039,4040,4041,4042,4349,4350,4351,4352,4658,4659,4660,4967,4968,4969,5586,5587,5588,5589,5895,5896,5897,5898,6205,6206,6207,6208,6515,6516,6517,6823,6824,6825,6826,7132,7133,7134,7135,7442,7443,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535}},
        {69u, {947,1256,1257,1258,1565,1566,1567,1874,1875,1876,2184,2185,2186,2493,2494,2495,2496,2803,2804,2805,3112,3113,3114,3422,3423,3424,3731,3732,3733,4040,4041,4042,4043,4350,4351,4352,4659,4660,4661,4969,4970,5588,5589,5896,5897,5898,5899,6205,6206,6207,6208,6209,6515,6516,6517,6518,6824,6825,6826,6827,7133,7134,7135,7136,7137,7443,7444,7445,7446,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535}},
      };

    int stepSector;
    int widthSector;
    int widthWindow;
    int numSector;

    int totalLzrRx;
    int totalLzrTx;

    quint16 LZR_HPrx[TSKWIN_SECTOR_NUM];
    quint16 LZR_PPrx[TSKWIN_SECTOR_NUM];
    quint16 LZR_HPtx[TSKWIN_SECTOR_NUM];
    quint16 LZR_PPtx[TSKWIN_SECTOR_NUM];

    int indx_cTx;
    int indx_cRx;
    int indx_rTx;
    int indx_rRx;

    tskWin_sector_t tskWin_rx_sector_s;
    tskWin_sector_t tskWin_tx_sector_s;
    tskWin_sector_t tskWin_temp_sector_s;
    quint16 TempBuf[150]; // greater than max size of RX/TX sector

    //QVector< QVector<quint16> > LZR_RX;
    //QVector< QVector<quint16> > LZR_TX;

    quint16 indexMax(quint16 buf_[], int size_, quint16 *max_);
    void sort(quint16 *buf_, int size_);
    quint16 median(quint16 *buf_, int size_);

    void pollutionMapping(tskWin_sector_t *sector_, quint16 bufIn[], int size_, int rbegin, int cbegin, int rlen, int clen);
    void removeOffset(tskWin_sector_t *sector_, quint16 offset_, int rsize_, int csize_);
    void imerode(tskWin_sector_t *sector_, int rsize_, int csize_, int factor_);
    void createMask(tskWin_sector_t *sector_, int rsize_, int csize_);
    quint16 calcAttenuation(tskWin_sector_t *sector_, int tot_, int rsize_, int csize_, int percent_);
};

#endif // ALG_H
